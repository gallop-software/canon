import { spawn } from 'child_process';
import { version, patterns, getPattern } from '../../index.js';
// Colors for terminal output
const c = {
    reset: '\x1b[0m',
    bold: '\x1b[1m',
    dim: '\x1b[2m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    cyan: '\x1b[36m',
};
// Build rule-to-pattern mapping from Canon schema (single source of truth)
const ruleToPattern = {};
for (const pattern of patterns) {
    if (pattern.rule) {
        ruleToPattern[pattern.rule] = pattern.id;
    }
}
function parseCanonFromMessage(message) {
    const match = message.match(/\[Canon (\d{3})\]/);
    return match ? match[1] : null;
}
function extractViolations(eslintOutput) {
    const violations = [];
    const lines = eslintOutput.split('\n');
    let currentFile = '';
    for (const line of lines) {
        // File path line (starts with /)
        if (line.startsWith('/') && !line.includes(':')) {
            currentFile = line.trim();
            continue;
        }
        // Violation line (starts with spaces, has line:col pattern)
        const match = line.match(/^\s+(\d+):(\d+)\s+(warning|error)\s+(.+?)\s{2,}([\w/-]+)$/);
        if (match && currentFile) {
            const [, lineNum, column, , message, ruleId] = match;
            const canonPattern = ruleToPattern[ruleId] || parseCanonFromMessage(message);
            const pattern = canonPattern ? getPattern(canonPattern) : null;
            violations.push({
                file: currentFile,
                line: parseInt(lineNum, 10),
                column: parseInt(column, 10),
                message: message.trim(),
                ruleId,
                canonPattern,
                patternTitle: pattern?.title || null,
            });
        }
    }
    return violations;
}
function countByPattern(violations) {
    const counts = {};
    for (const v of violations) {
        const key = v.canonPattern || 'other';
        counts[key] = (counts[key] || 0) + 1;
    }
    return counts;
}
function groupByFile(violations) {
    const groups = new Map();
    for (const v of violations) {
        const existing = groups.get(v.file) || [];
        existing.push(v);
        groups.set(v.file, existing);
    }
    return groups;
}
function printReport(result, options) {
    if (options.json) {
        console.log(JSON.stringify(result, null, 2));
        return;
    }
    // Header
    console.log('');
    console.log(`${c.bold}╔════════════════════════════════════════════════════════════╗${c.reset}`);
    console.log(`${c.bold}║${c.reset}           ${c.cyan}Gallop Canon${c.reset} ${c.dim}v${result.version}${c.reset} ${c.bold}Compliance Report${c.reset}           ${c.bold}║${c.reset}`);
    console.log(`${c.bold}╚════════════════════════════════════════════════════════════╝${c.reset}`);
    console.log('');
    if (result.violations.length === 0) {
        console.log(`  ${c.green}✓${c.reset} ${c.bold}All files pass Canon compliance checks${c.reset}`);
        console.log(`  ${c.dim}Path: ${result.path}${c.reset}`);
        console.log('');
        return;
    }
    // Summary
    const filesWithViolations = new Set(result.violations.map(v => v.file)).size;
    console.log(`  ${c.red}✗${c.reset} ${c.bold}${result.violations.length} violation${result.violations.length === 1 ? '' : 's'}${c.reset} in ${filesWithViolations} file${filesWithViolations === 1 ? '' : 's'}`);
    console.log(`  ${c.dim}Path: ${result.path}${c.reset}`);
    console.log('');
    // Violations by pattern
    console.log(`${c.bold}  Violations by Pattern:${c.reset}`);
    for (const [patternId, count] of Object.entries(result.summary.byPattern).sort()) {
        const pattern = getPattern(patternId);
        const title = pattern?.title || 'Other';
        console.log(`    ${c.yellow}${patternId}${c.reset} ${title}: ${c.bold}${count}${c.reset}`);
    }
    console.log('');
    // Detailed violations by file
    console.log(`${c.bold}  Details:${c.reset}`);
    console.log('');
    const byFile = groupByFile(result.violations);
    for (const [file, violations] of byFile) {
        // Shorten file path for display
        const shortPath = file.replace(process.cwd() + '/', '');
        console.log(`  ${c.cyan}${shortPath}${c.reset}`);
        for (const v of violations) {
            const patternLabel = v.canonPattern
                ? `${c.yellow}[${v.canonPattern}]${c.reset}`
                : `${c.dim}[---]${c.reset}`;
            const location = `${c.dim}${v.line}:${v.column}${c.reset}`;
            // Clean up message (remove [Canon XXX] prefix since we show it separately)
            const cleanMessage = v.message.replace(/\[Canon \d{3}\]\s*/, '');
            console.log(`    ${location} ${patternLabel} ${cleanMessage}`);
        }
        console.log('');
    }
    // Footer
    console.log(`${c.dim}  ─────────────────────────────────────────────────────────${c.reset}`);
    console.log(`  ${c.dim}Fix violations manually following the Canon patterns${c.reset}`);
    console.log('');
}
export async function audit(path, options) {
    return new Promise((resolve, reject) => {
        const args = [
            'eslint',
            path,
            '--format', 'stylish',
        ];
        if (options.fix) {
            args.push('--fix');
        }
        const eslint = spawn('npx', args, {
            cwd: process.cwd(),
            stdio: ['inherit', 'pipe', 'pipe'],
            shell: true,
        });
        let stdout = '';
        let stderr = '';
        eslint.stdout?.on('data', (data) => {
            stdout += data.toString();
        });
        eslint.stderr?.on('data', (data) => {
            stderr += data.toString();
        });
        eslint.on('close', (code) => {
            const violations = extractViolations(stdout);
            const result = {
                version,
                timestamp: new Date().toISOString(),
                path,
                totalFiles: 0, // ESLint stylish format doesn't give us this easily
                violations,
                summary: {
                    total: violations.length,
                    byPattern: countByPattern(violations),
                },
            };
            printReport(result, options);
            if (options.strict && violations.length > 0) {
                process.exit(1);
            }
            resolve();
        });
        eslint.on('error', (error) => {
            reject(error);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXVkaXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2xpL2NvbW1hbmRzL2F1ZGl0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDckMsT0FBTyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUE4QjlELDZCQUE2QjtBQUM3QixNQUFNLENBQUMsR0FBRztJQUNSLEtBQUssRUFBRSxTQUFTO0lBQ2hCLElBQUksRUFBRSxTQUFTO0lBQ2YsR0FBRyxFQUFFLFNBQVM7SUFDZCxHQUFHLEVBQUUsVUFBVTtJQUNmLEtBQUssRUFBRSxVQUFVO0lBQ2pCLE1BQU0sRUFBRSxVQUFVO0lBQ2xCLElBQUksRUFBRSxVQUFVO0lBQ2hCLElBQUksRUFBRSxVQUFVO0NBQ2pCLENBQUE7QUFFRCwyRUFBMkU7QUFDM0UsTUFBTSxhQUFhLEdBQTJCLEVBQUUsQ0FBQTtBQUNoRCxLQUFLLE1BQU0sT0FBTyxJQUFJLFFBQVEsRUFBRSxDQUFDO0lBQy9CLElBQUksT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2pCLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLEVBQUUsQ0FBQTtJQUMxQyxDQUFDO0FBQ0gsQ0FBQztBQUVELFNBQVMscUJBQXFCLENBQUMsT0FBZTtJQUM1QyxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUE7SUFDaEQsT0FBTyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFBO0FBQ2hDLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLFlBQW9CO0lBQzdDLE1BQU0sVUFBVSxHQUFnQixFQUFFLENBQUE7SUFDbEMsTUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLEtB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LENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNwYXduIH0gZnJvbSAnY2hpbGRfcHJvY2VzcydcbmltcG9ydCB7IHZlcnNpb24sIHBhdHRlcm5zLCBnZXRQYXR0ZXJuIH0gZnJvbSAnLi4vLi4vaW5kZXguanMnXG5cbmludGVyZmFjZSBBdWRpdE9wdGlvbnMge1xuICBzdHJpY3Q6IGJvb2xlYW5cbiAganNvbjogYm9vbGVhblxuICBmaXg6IGJvb2xlYW5cbn1cblxuaW50ZXJmYWNlIFZpb2xhdGlvbiB7XG4gIGZpbGU6IHN0cmluZ1xuICBsaW5lOiBudW1iZXJcbiAgY29sdW1uOiBudW1iZXJcbiAgbWVzc2FnZTogc3RyaW5nXG4gIHJ1bGVJZDogc3RyaW5nXG4gIGNhbm9uUGF0dGVybjogc3RyaW5nIHwgbnVsbFxuICBwYXR0ZXJuVGl0bGU6IHN0cmluZyB8IG51bGxcbn1cblxuaW50ZXJmYWNlIEF1ZGl0UmVzdWx0IHtcbiAgdmVyc2lvbjogc3RyaW5nXG4gIHRpbWVzdGFtcDogc3RyaW5nXG4gIHBhdGg6IHN0cmluZ1xuICB0b3RhbEZpbGVzOiBudW1iZXJcbiAgdmlvbGF0aW9uczogVmlvbGF0aW9uW11cbiAgc3VtbWFyeToge1xuICAgIHRvdGFsOiBudW1iZXJcbiAgICBieVBhdHRlcm46IFJlY29yZDxzdHJpbmcsIG51bWJlcj5cbiAgfVxufVxuXG4vLyBDb2xvcnMgZm9yIHRlcm1pbmFsIG91dHB1dFxuY29uc3QgYyA9IHtcbiAgcmVzZXQ6ICdcXHgxYlswbScsXG4gIGJvbGQ6ICdcXHgxYlsxbScsXG4gIGRpbTogJ1xceDFiWzJtJyxcbiAgcmVkOiAnXFx4MWJbMzFtJyxcbiAgZ3JlZW46ICdcXHgxYlszMm0nLFxuICB5ZWxsb3c6ICdcXHgxYlszM20nLFxuICBibHVlOiAnXFx4MWJbMzRtJyxcbiAgY3lhbjogJ1xceDFiWzM2bScsXG59XG5cbi8vIEJ1aWxkIHJ1bGUtdG8tcGF0dGVybiBtYXBwaW5nIGZyb20gQ2Fub24gc2NoZW1hIChzaW5nbGUgc291cmNlIG9mIHRydXRoKVxuY29uc3QgcnVsZVRvUGF0dGVybjogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9XG5mb3IgKGNvbnN0IHBhdHRlcm4gb2YgcGF0dGVybnMpIHtcbiAgaWYgKHBhdHRlcm4ucnVsZSkge1xuICAgIHJ1bGVUb1BhdHRlcm5bcGF0dGVybi5ydWxlXSA9IHBhdHRlcm4uaWRcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUNhbm9uRnJvbU1lc3NhZ2UobWVzc2FnZTogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG4gIGNvbnN0IG1hdGNoID0gbWVzc2FnZS5tYXRjaCgvXFxbQ2Fub24gKFxcZHszfSlcXF0vKVxuICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IG51bGxcbn1cblxuZnVuY3Rpb24gZXh0cmFjdFZpb2xhdGlvbnMoZXNsaW50T3V0cHV0OiBzdHJpbmcpOiBWaW9sYXRpb25bXSB7XG4gIGNvbnN0IHZpb2xhdGlvbnM6IFZpb2xhdGlvbltdID0gW11cbiAgY29uc3QgbGluZXMgPSBlc2xpbnRPdXRwdXQuc3BsaXQoJ1xcbicpXG4gIFxuICBsZXQgY3VycmVudEZpbGUgPSAnJ1xuICBcbiAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgLy8gRmlsZSBwYXRoIGxpbmUgKHN0YXJ0cyB3aXRoIC8pXG4gICAgaWYgKGxpbmUuc3RhcnRzV2l0aCgnLycpICYmICFsaW5lLmluY2x1ZGVzKCc6JykpIHtcbiAgICAgIGN1cnJlbnRGaWxlID0gbGluZS50cmltKClcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuICAgIFxuICAgIC8vIFZpb2xhdGlvbiBsaW5lIChzdGFydHMgd2l0aCBzcGFjZXMsIGhhcyBsaW5lOmNvbCBwYXR0ZXJuKVxuICAgIGNvbnN0IG1hdGNoID0gbGluZS5tYXRjaCgvXlxccysoXFxkKyk6KFxcZCspXFxzKyh3YXJuaW5nfGVycm9yKVxccysoLis/KVxcc3syLH0oW1xcdy8tXSspJC8pXG4gICAgaWYgKG1hdGNoICYmIGN1cnJlbnRGaWxlKSB7XG4gICAgICBjb25zdCBbLCBsaW5lTnVtLCBjb2x1bW4sICwgbWVzc2FnZSwgcnVsZUlkXSA9IG1hdGNoXG4gICAgICBjb25zdCBjYW5vblBhdHRlcm4gPSBydWxlVG9QYXR0ZXJuW3J1bGVJZF0gfHwgcGFyc2VDYW5vbkZyb21NZXNzYWdlKG1lc3NhZ2UpXG4gICAgICBjb25zdCBwYXR0ZXJuID0gY2Fub25QYXR0ZXJuID8gZ2V0UGF0dGVybihjYW5vblBhdHRlcm4pIDogbnVsbFxuICAgICAgXG4gICAgICB2aW9sYXRpb25zLnB1c2goe1xuICAgICAgICBmaWxlOiBjdXJyZW50RmlsZSxcbiAgICAgICAgbGluZTogcGFyc2VJbnQobGluZU51bSwgMTApLFxuICAgICAgICBjb2x1bW46IHBhcnNlSW50KGNvbHVtbiwgMTApLFxuICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLnRyaW0oKSxcbiAgICAgICAgcnVsZUlkLFxuICAgICAgICBjYW5vblBhdHRlcm4sXG4gICAgICAgIHBhdHRlcm5UaXRsZTogcGF0dGVybj8udGl0bGUgfHwgbnVsbCxcbiAgICAgIH0pXG4gICAgfVxuICB9XG4gIFxuICByZXR1cm4gdmlvbGF0aW9uc1xufVxuXG5mdW5jdGlvbiBjb3VudEJ5UGF0dGVybih2aW9sYXRpb25zOiBWaW9sYXRpb25bXSk6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4ge1xuICBjb25zdCBjb3VudHM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fVxuICBmb3IgKGNvbnN0IHYgb2YgdmlvbGF0aW9ucykge1xuICAgIGNvbnN0IGtleSA9IHYuY2Fub25QYXR0ZXJuIHx8ICdvdGhlcidcbiAgICBjb3VudHNba2V5XSA9IChjb3VudHNba2V5XSB8fCAwKSArIDFcbiAgfVxuICByZXR1cm4gY291bnRzXG59XG5cbmZ1bmN0aW9uIGdyb3VwQnlGaWxlKHZpb2xhdGlvbnM6IFZpb2xhdGlvbltdKTogTWFwPHN0cmluZywgVmlvbGF0aW9uW10+IHtcbiAgY29uc3QgZ3JvdXBzID0gbmV3IE1hcDxzdHJpbmcsIFZpb2xhdGlvbltdPigpXG4gIGZvciAoY29uc3QgdiBvZiB2aW9sYXRpb25zKSB7XG4gICAgY29uc3QgZXhpc3RpbmcgPSBncm91cHMuZ2V0KHYuZmlsZSkgfHwgW11cbiAgICBleGlzdGluZy5wdXNoKHYpXG4gICAgZ3JvdXBzLnNldCh2LmZpbGUsIGV4aXN0aW5nKVxuICB9XG4gIHJldHVybiBncm91cHNcbn1cblxuZnVuY3Rpb24gcHJpbnRSZXBvcnQocmVzdWx0OiBBdWRpdFJlc3VsdCwgb3B0aW9uczogQXVkaXRPcHRpb25zKSB7XG4gIGlmIChvcHRpb25zLmpzb24pIHtcbiAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZXN1bHQsIG51bGwsIDIpKVxuICAgIHJldHVyblxuICB9XG5cbiAgLy8gSGVhZGVyXG4gIGNvbnNvbGUubG9nKCcnKVxuICBjb25zb2xlLmxvZyhgJHtjLmJvbGR94pWU4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWXJHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKGAke2MuYm9sZH3ilZEke2MucmVzZXR9ICAgICAgICAgICAke2MuY3lhbn1HYWxsb3AgQ2Fub24ke2MucmVzZXR9ICR7Yy5kaW19diR7cmVzdWx0LnZlcnNpb259JHtjLnJlc2V0fSAke2MuYm9sZH1Db21wbGlhbmNlIFJlcG9ydCR7Yy5yZXNldH0gICAgICAgICAgICR7Yy5ib2xkfeKVkSR7Yy5yZXNldH1gKVxuICBjb25zb2xlLmxvZyhgJHtjLmJvbGR94pWa4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWdJHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKCcnKVxuXG4gIGlmIChyZXN1bHQudmlvbGF0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICBjb25zb2xlLmxvZyhgICAke2MuZ3JlZW594pyTJHtjLnJlc2V0fSAke2MuYm9sZH1BbGwgZmlsZXMgcGFzcyBDYW5vbiBjb21wbGlhbmNlIGNoZWNrcyR7Yy5yZXNldH1gKVxuICAgIGNvbnNvbGUubG9nKGAgICR7Yy5kaW19UGF0aDogJHtyZXN1bHQucGF0aH0ke2MucmVzZXR9YClcbiAgICBjb25zb2xlLmxvZygnJylcbiAgICByZXR1cm5cbiAgfVxuXG4gIC8vIFN1bW1hcnlcbiAgY29uc3QgZmlsZXNXaXRoVmlvbGF0aW9ucyA9IG5ldyBTZXQocmVzdWx0LnZpb2xhdGlvbnMubWFwKHYgPT4gdi5maWxlKSkuc2l6ZVxuICBjb25zb2xlLmxvZyhgICAke2MucmVkfeKclyR7Yy5yZXNldH0gJHtjLmJvbGR9JHtyZXN1bHQudmlvbGF0aW9ucy5sZW5ndGh9IHZpb2xhdGlvbiR7cmVzdWx0LnZpb2xhdGlvbnMubGVuZ3RoID09PSAxID8gJycgOiAncyd9JHtjLnJlc2V0fSBpbiAke2ZpbGVzV2l0aFZpb2xhdGlvbnN9IGZpbGUke2ZpbGVzV2l0aFZpb2xhdGlvbnMgPT09IDEgPyAnJyA6ICdzJ31gKVxuICBjb25zb2xlLmxvZyhgICAke2MuZGltfVBhdGg6ICR7cmVzdWx0LnBhdGh9JHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKCcnKVxuXG4gIC8vIFZpb2xhdGlvbnMgYnkgcGF0dGVyblxuICBjb25zb2xlLmxvZyhgJHtjLmJvbGR9ICBWaW9sYXRpb25zIGJ5IFBhdHRlcm46JHtjLnJlc2V0fWApXG4gIGZvciAoY29uc3QgW3BhdHRlcm5JZCwgY291bnRdIG9mIE9iamVjdC5lbnRyaWVzKHJlc3VsdC5zdW1tYXJ5LmJ5UGF0dGVybikuc29ydCgpKSB7XG4gICAgY29uc3QgcGF0dGVybiA9IGdldFBhdHRlcm4ocGF0dGVybklkKVxuICAgIGNvbnN0IHRpdGxlID0gcGF0dGVybj8udGl0bGUgfHwgJ090aGVyJ1xuICAgIGNvbnNvbGUubG9nKGAgICAgJHtjLnllbGxvd30ke3BhdHRlcm5JZH0ke2MucmVzZXR9ICR7dGl0bGV9OiAke2MuYm9sZH0ke2NvdW50fSR7Yy5yZXNldH1gKVxuICB9XG4gIGNvbnNvbGUubG9nKCcnKVxuXG4gIC8vIERldGFpbGVkIHZpb2xhdGlvbnMgYnkgZmlsZVxuICBjb25zb2xlLmxvZyhgJHtjLmJvbGR9ICBEZXRhaWxzOiR7Yy5yZXNldH1gKVxuICBjb25zb2xlLmxvZygnJylcblxuICBjb25zdCBieUZpbGUgPSBncm91cEJ5RmlsZShyZXN1bHQudmlvbGF0aW9ucylcbiAgZm9yIChjb25zdCBbZmlsZSwgdmlvbGF0aW9uc10gb2YgYnlGaWxlKSB7XG4gICAgLy8gU2hvcnRlbiBmaWxlIHBhdGggZm9yIGRpc3BsYXlcbiAgICBjb25zdCBzaG9ydFBhdGggPSBmaWxlLnJlcGxhY2UocHJvY2Vzcy5jd2QoKSArICcvJywgJycpXG4gICAgY29uc29sZS5sb2coYCAgJHtjLmN5YW59JHtzaG9ydFBhdGh9JHtjLnJlc2V0fWApXG4gICAgXG4gICAgZm9yIChjb25zdCB2IG9mIHZpb2xhdGlvbnMpIHtcbiAgICAgIGNvbnN0IHBhdHRlcm5MYWJlbCA9IHYuY2Fub25QYXR0ZXJuIFxuICAgICAgICA/IGAke2MueWVsbG93fVske3YuY2Fub25QYXR0ZXJufV0ke2MucmVzZXR9YCBcbiAgICAgICAgOiBgJHtjLmRpbX1bLS0tXSR7Yy5yZXNldH1gXG4gICAgICBjb25zdCBsb2NhdGlvbiA9IGAke2MuZGltfSR7di5saW5lfToke3YuY29sdW1ufSR7Yy5yZXNldH1gXG4gICAgICBcbiAgICAgIC8vIENsZWFuIHVwIG1lc3NhZ2UgKHJlbW92ZSBbQ2Fub24gWFhYXSBwcmVmaXggc2luY2Ugd2Ugc2hvdyBpdCBzZXBhcmF0ZWx5KVxuICAgICAgY29uc3QgY2xlYW5NZXNzYWdlID0gdi5tZXNzYWdlLnJlcGxhY2UoL1xcW0Nhbm9uIFxcZHszfVxcXVxccyovLCAnJylcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coYCAgICAke2xvY2F0aW9ufSAke3BhdHRlcm5MYWJlbH0gJHtjbGVhbk1lc3NhZ2V9YClcbiAgICB9XG4gICAgY29uc29sZS5sb2coJycpXG4gIH1cblxuICAvLyBGb290ZXJcbiAgY29uc29sZS5sb2coYCR7Yy5kaW19ICDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAke2MucmVzZXR9YClcbiAgY29uc29sZS5sb2coYCAgJHtjLmRpbX1GaXggdmlvbGF0aW9ucyBtYW51YWxseSBmb2xsb3dpbmcgdGhlIENhbm9uIHBhdHRlcm5zJHtjLnJlc2V0fWApXG4gIGNvbnNvbGUubG9nKCcnKVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYXVkaXQocGF0aDogc3RyaW5nLCBvcHRpb25zOiBBdWRpdE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBhcmdzID0gW1xuICAgICAgJ2VzbGludCcsXG4gICAgICBwYXRoLFxuICAgICAgJy0tZm9ybWF0JywgJ3N0eWxpc2gnLFxuICAgIF1cblxuICAgIGlmIChvcHRpb25zLmZpeCkge1xuICAgICAgYXJncy5wdXNoKCctLWZpeCcpXG4gICAgfVxuXG4gICAgY29uc3QgZXNsaW50ID0gc3Bhd24oJ25weCcsIGFyZ3MsIHtcbiAgICAgIGN3ZDogcHJvY2Vzcy5jd2QoKSxcbiAgICAgIHN0ZGlvOiBbJ2luaGVyaXQnLCAncGlwZScsICdwaXBlJ10sXG4gICAgICBzaGVsbDogdHJ1ZSxcbiAgICB9KVxuXG4gICAgbGV0IHN0ZG91dCA9ICcnXG4gICAgbGV0IHN0ZGVyciA9ICcnXG5cbiAgICBlc2xpbnQuc3Rkb3V0Py5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICBzdGRvdXQgKz0gZGF0YS50b1N0cmluZygpXG4gICAgfSlcblxuICAgIGVzbGludC5zdGRlcnI/Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgIHN0ZGVyciArPSBkYXRhLnRvU3RyaW5nKClcbiAgICB9KVxuXG4gICAgZXNsaW50Lm9uKCdjbG9zZScsIChjb2RlKSA9PiB7XG4gICAgICBjb25zdCB2aW9sYXRpb25zID0gZXh0cmFjdFZpb2xhdGlvbnMoc3Rkb3V0KVxuICAgICAgXG4gICAgICBjb25zdCByZXN1bHQ6IEF1ZGl0UmVzdWx0ID0ge1xuICAgICAgICB2ZXJzaW9uLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgcGF0aCxcbiAgICAgICAgdG90YWxGaWxlczogMCwgLy8gRVNMaW50IHN0eWxpc2ggZm9ybWF0IGRvZXNuJ3QgZ2l2ZSB1cyB0aGlzIGVhc2lseVxuICAgICAgICB2aW9sYXRpb25zLFxuICAgICAgICBzdW1tYXJ5OiB7XG4gICAgICAgICAgdG90YWw6IHZpb2xhdGlvbnMubGVuZ3RoLFxuICAgICAgICAgIGJ5UGF0dGVybjogY291bnRCeVBhdHRlcm4odmlvbGF0aW9ucyksXG4gICAgICAgIH0sXG4gICAgICB9XG5cbiAgICAgIHByaW50UmVwb3J0KHJlc3VsdCwgb3B0aW9ucylcblxuICAgICAgaWYgKG9wdGlvbnMuc3RyaWN0ICYmIHZpb2xhdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICBwcm9jZXNzLmV4aXQoMSlcbiAgICAgIH1cblxuICAgICAgcmVzb2x2ZSgpXG4gICAgfSlcblxuICAgIGVzbGludC5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgIHJlamVjdChlcnJvcilcbiAgICB9KVxuICB9KVxufVxuIl19